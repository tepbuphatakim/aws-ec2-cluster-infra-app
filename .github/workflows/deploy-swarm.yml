name: Deploy to Swarm (Manual)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (e.g. uat-v0.1.0 for UAT or v0.1.0 for PROD)'
        required: true
        type: string

env:
  DOCKER_IMAGE: ${{ vars.DOCKER_IMAGE }}

jobs:
  deploy-uat:
    name: Deploy to UAT
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.event.inputs.image_tag, 'uat') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH agent (UAT)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_UAT }}

      - name: Add UAT host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SSH_HOST_UAT }}" >> ~/.ssh/known_hosts

      - name: Deploy stack to Docker Swarm (UAT)
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}
        run: |
          set -e

          echo "Deploying image to UAT: ${DOCKER_IMAGE}:${IMAGE_TAG}"

          # Copy stack file to UAT host
          scp stack.yml "${{ secrets.SSH_USER_UAT }}@${{ secrets.SSH_HOST_UAT }}:/tmp/stack.yml"

          # Execute deployment on the UAT Swarm manager
          ssh "${{ secrets.SSH_USER_UAT }}@${{ secrets.SSH_HOST_UAT }}" "IMAGE_TAG=${IMAGE_TAG} DOCKER_IMAGE=${DOCKER_IMAGE} bash -s" << 'EOF'
          set -e

          echo "Rendering stack file with IMAGE_TAG=${IMAGE_TAG}"
          # envsubst is part of gettext; ensure it's installed on the manager node
          envsubst < /tmp/stack.yml > /tmp/stack_rendered.yml

          echo "Deploying stack nginx-stack..."
          docker stack deploy \
            --with-registry-auth \
            -c /tmp/stack_rendered.yml \
            nginx-stack

          echo "Current service tasks:"
          docker service ps --no-trunc nginx-stack_nginx || true

          echo "Waiting for tasks to stabilize..."
          sleep 30

          echo "Checking for failed or rejected tasks..."
          FAILED_TASKS=$(docker service ps nginx-stack_nginx --format '{{.CurrentState}}' | grep -E 'Failed|Rejected' || true)

          if [ -n "$FAILED_TASKS" ]; then
            echo "Deployment failures detected:"
            echo "$FAILED_TASKS"
            echo "Rolling back service nginx-stack_nginx..."
            docker service rollback nginx-stack_nginx || true
            exit 1
          fi

          echo "Deployment appears healthy."
          EOF

      - name: Deployment summary (UAT)
        if: always()
        run: |
          echo "Requested image (UAT): ${DOCKER_IMAGE}:${{ github.event.inputs.image_tag }}"

  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    # Any tag that does NOT start with "uat" will be treated as PROD (e.g. v0.0.0)
    if: ${{ !startsWith(github.event.inputs.image_tag, 'uat') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH agent (PROD)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_PROD }}

      - name: Add PROD host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SSH_HOST_PROD }}" >> ~/.ssh/known_hosts

      - name: Deploy stack to Docker Swarm (PROD)
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}
        run: |
          set -e

          echo "Deploying image to PROD: ${DOCKER_IMAGE}:${IMAGE_TAG}"

          # Copy stack file to PROD host
          scp stack.yml "${{ secrets.SSH_USER_PROD }}@${{ secrets.SSH_HOST_PROD }}:/tmp/stack.yml"

          # Execute deployment on the PROD Swarm manager
          ssh "${{ secrets.SSH_USER_PROD }}@${{ secrets.SSH_HOST_PROD }}" "IMAGE_TAG=${IMAGE_TAG} DOCKER_IMAGE=${DOCKER_IMAGE} bash -s" << 'EOF'
          set -e

          echo "Rendering stack file with IMAGE_TAG=${IMAGE_TAG}"
          # envsubst is part of gettext; ensure it's installed on the manager node
          envsubst < /tmp/stack.yml > /tmp/stack_rendered.yml

          echo "Deploying stack nginx-stack..."
          docker stack deploy \
            --with-registry-auth \
            -c /tmp/stack_rendered.yml \
            nginx-stack

          echo "Current service tasks:"
          docker service ps --no-trunc nginx-stack_nginx || true

          echo "Waiting for tasks to stabilize..."
          sleep 30

          echo "Checking for failed or rejected tasks..."
          FAILED_TASKS=$(docker service ps nginx-stack_nginx --format '{{.CurrentState}}' | grep -E 'Failed|Rejected' || true)

          if [ -n "$FAILED_TASKS" ]; then
            echo "Deployment failures detected:"
            echo "$FAILED_TASKS"
            echo "Rolling back service nginx-stack_nginx..."
            docker service rollback nginx-stack_nginx || true
            exit 1
          fi

          echo "Deployment appears healthy."
          EOF

      - name: Deployment summary (PROD)
        if: always()
        run: |
          echo "Requested image (PROD): ${DOCKER_IMAGE}:${{ github.event.inputs.image_tag }}"

